import{Howl}from"howler";import*as Misc from"./misc.js";import*as Random from"./random.js";import{ShaderView}from"./shaderview.js";import BackgroundShader from"../shader/background.frag.glsl";import AudioSrcAirhorn from"../audio/airhorn.mp3";import AudioSrcDamnson from"../audio/damnson.mp3";import AudioSrcHitmarker from"../audio/hitmarker.mp3";import AudioSrcMomgetthecamera from"../audio/momgetthecamera.mp3";import AudioSrcOhbabyatriple from"../audio/ohbabyatriple.mp3";import AudioSrcSad from"../audio/sad.mp3";import AudioSrcSanic from"../audio/sanic.mp3";import AudioSrcSmokeweedeveryday from"../audio/smokeweedeveryday.mp3";import AudioSrcWow from"../audio/wow.mp3";const Audio=[["airhorn",AudioSrcAirhorn],["damnson",AudioSrcDamnson],["hitmarker",AudioSrcHitmarker],["momgetthecamera",AudioSrcMomgetthecamera],["ohbabyatriple",AudioSrcOhbabyatriple],["sad",AudioSrcSad],["sanic",AudioSrcSanic],["smokeweeeveryday",AudioSrcSmokeweedeveryday],["wow",AudioSrcWow]].reduce(((e,[t,a])=>(e[t]=new Howl({src:[a]}),e)),{}),Anim={async show(e,t){let a=document.querySelector(".animations");a.appendChild(e),await Misc.sleep(t),a.removeChild(e)},async prepareTransition(){await Misc.animationFrame(),await Misc.animationFrame()},async shake(e,t){for(;t>0;){const a=Random.uniform()*t*2,o=Random.uniform()*t*2,r=Random.uniform()*t*4;e.style.transform=`translate(${a}vw, ${o}vw) rotate(${r}deg)`;const i=performance.now();await Misc.animationFrame(),t-=(performance.now()-i)/1e3}e.style.transform=""},showGameText(e,t){let a=Misc.elementFromHtml(`\n\t\t\t<span class="anim anim-text text-game">${e}</span>\n\t\t`);a.style.left=80*Math.random()+10+"%",a.style.top=80*Math.random()+10+"%",a.style.transform=`rotate(${45*Random.uniform()}deg)`,Anim.show(a,t)}};export class View{constructor(e){this.game=e,this.scoreLerp=1,this.timeLevel=0,this.update(e.board),this.game.on("move",(e=>{document.querySelector(".game").classList.remove("game-state-begin"),this.update(e.newBoard);const t=e.diff.add.reduce(((e,t)=>Math.max(e,t.val)),0);32==t?Barage.airhorns():128==t?Barage.sanic():512==t?Audio.smokeweedeveryday.play():t>4&&Barage.default(),e.diff.add.filter((e=>e.merged)).forEach(((e,t)=>{const a=document.getElementById("cell-"+e.id);setTimeout((()=>{let e=Misc.elementFromHtml('\n\t\t\t\t\t\t\t<div class="anim anim-hitmarker anim-image"></div>\n\t\t\t\t\t\t');const t=a.getBoundingClientRect(),o=(t.right-t.left)/2,r=(t.bottom-t.top)/2;e.style.left=t.left+o+.5*o*Random.uniform()+"px",e.style.top=t.top+r+.5*r*Random.uniform()+"px",Anim.show(e,500),Audio.hitmarker.play()}),100+50*t)})),setTimeout((()=>{Anim.shake(document.querySelector(".game-board"),e.diff.add.length/6)}),100)})),this.game.on("lose",(e=>{Audio.sad.play(),document.querySelector(".game").classList.add("game-state-lose");const t=this.game.score();var a=t<400?0:t<800?1:t<1600?2:3;const o=document.querySelectorAll(`.lose-tier-${a}`);Random.pick(o).classList.remove("lose-text")})),this.game.on("win",(e=>{Anim.shake(document.querySelector(".game-board"),3)}));try{const e=document.querySelector(".gl-background");let t=new ShaderView(e,BackgroundShader);t.on("pre-render",(e=>{this.scoreLerp+=Math.sqrt(Math.max(this.game.score()-this.scoreLerp,0)/80),this.timeLevel+=Math.min(this.scoreLerp/1e3,.5),t.gl.uniform1f(t.uniform("level"),this.scoreLerp/512),t.gl.uniform1f(t.uniform("time_level"),this.timeLevel)}))}catch(e){console.error(e.message)}}update(e){e.flat().filter((e=>e.val>0)).forEach(((e,t)=>{let a=document.getElementById("cell-"+e.id);a||((a=Misc.elementFromHtml(`\n\t\t\t\t\t\t<div class="game-cell game-cell-${e.val}"><span></span></div>\n\t\t\t\t\t`)).id="cell-"+e.id,document.querySelector(".game-board-cells").appendChild(a),(e.merged||[]).forEach((t=>{let a=document.getElementById("cell-"+t);a.style.left=25*e.x+"%",a.style.top=25*e.y+"%",a.classList.add("fade-out"),setTimeout((()=>a.parentNode.removeChild(a)),200)}))),a.style.left=e.x/4*100+"%",a.style.top=e.y/4*100+"%"})),Array.prototype.forEach.call(document.querySelectorAll(".game-score"),(e=>{e.innerHTML=this.game.score()}),this)}}const Barage={default(){Random.bool(.1)&&Audio[Random.pick(["damnson","momgetthecamera","ohbabyatriple","wow"])].play(),Anim.showGameText(Random.pick(["DAYUM","I'll rekt u m8","LMAO","XD","sweg","ur whalecum","h8tr"]),500)},airhorns(){for(let e=0;e<4;e++)setTimeout((async()=>{Audio.airhorn.play();let e=Misc.elementFromHtml('\n\t\t\t\t\t<div class="anim anim-airhorn">\n\t\t\t\t\t\t<div class="anim-image"></div>\n\t\t\t\t\t</div>\n\t\t\t\t');e.style.top=80*Math.random()+10+"%",e.style.left=80*Math.random()+10+"%";const t=60*Random.uniform();let a=e.querySelector(".anim-image");a.style.transform=`rotate(${t}deg)`,Anim.show(e,1500),await Anim.prepareTransition();const o=t+Random.inv()*(30+240*Math.random());a.style.transform=`rotate(${o}deg)`}),200*e)},async sanic(){Audio.sanic.play(),["such speed","2fast4me","sanic hegehog","gtg fast","catch me m8"].forEach(((e,t)=>{setTimeout((()=>Anim.showGameText(e,500)),100+300*t)}));for(let e=0;e<6;e++)setTimeout((async()=>{let e=Misc.elementFromHtml('\n\t\t\t\t\t<div class="anim anim-sanic">\n\t\t\t\t\t\t<div class="anim-image"></div>\n\t\t\t\t\t</div>\n\t\t\t\t');const t=.8*Math.random()+.1,a=.8*Math.random()+.1,o=document.querySelector(".animations"),r=Math.atan2(o.clientWidth,o.clientHeight*(t-a))-Math.PI/2;e.querySelector(".anim-image").style.transform=`rotate(${r}rad)`,e.style.left="-300px",e.style.top=100*t+"%",Anim.show(e,2e3),await Anim.prepareTransition(),e.style.top=100*a+"%",e.style.left="calc(100% + 300px)"}),300*e)}};
